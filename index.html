<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#1a1a2e" />
    <meta
      name="description"
      content="Magic Chess - Aplikasi Prediksi Urutan Musuh"
    />
    <title>Magic Chess - Prediksi Urutan (UX Optimized)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        min-height: 100vh;
      }

      .glow {
        box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
      }

      /* Tambahan Style untuk highlight Fighting */
      .fighting-pulse {
        animation: fightingPulse 1.5s infinite;
      }

      @keyframes fightingPulse {
        0%,
        100% {
          box-shadow: 0 0 0 rgba(16, 185, 129, 0.4);
        }
        50% {
          box-shadow: 0 0 15px rgba(16, 185, 129, 0.9);
        }
      }

      .eliminated {
        background: linear-gradient(
          135deg,
          #7f1d1d 0%,
          #450a0a 100%
        ) !important;
        border-color: #dc2626 !important;
        opacity: 0.7;
      }

      .eliminated .player-name {
        text-decoration: line-through;
      }

      .fighting {
        background: linear-gradient(
          135deg,
          #065f46 0%,
          #064e3b 100%
        ) !important;
        border-color: #10b981 !important;
        box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
      }

      .eliminate-btn {
        transition: all 0.3s ease;
      }

      .eliminate-btn:active {
        transform: scale(0.95);
      }

      .select-container {
        position: relative;
      }

      .position-badge {
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.8;
        }
      }

      .success-animation {
        animation: successPulse 0.5s ease;
      }

      @keyframes successPulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      .empty-slot {
        border: 2px dashed #4b5563;
        background: rgba(31, 41, 55, 0.5);
      }

      .filled-slot {
        border: 2px solid #f59e0b;
        background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
      }

      .auto-filled-slot {
        border: 2px solid #10b981;
        background: linear-gradient(135deg, #065f46 0%, #064e3b 100%);
      }

      .select-arrow {
        pointer-events: none;
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
      }

      .auto-label {
        animation: fadeIn 0.5s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body class="p-4">
    <div class="max-w-2xl mx-auto">
      <div class="mt-4 mb-8 text-center">
        <h1 class="mb-2 text-4xl font-bold text-amber-400">‚öîÔ∏è Magic Chess</h1>
        <p class="text-sm text-gray-300">
          Prediksi Urutan Musuh - **UX Optimized**
        </p>
        <p class="mt-2 text-xs text-gray-500">
          <span id="savedIndicator" class="hidden text-green-400"
            >‚úì Data tersimpan otomatis</span
          >
        </p>
      </div>

      <div
        id="inputSection"
        class="p-6 mb-6 bg-gray-800 rounded-lg shadow-2xl glow"
      >
        <h2 class="mb-4 text-2xl font-bold text-amber-400">
          üìù Masukkan Nama 7 Musuh
        </h2>
        <div id="inputFields" class="mb-4 space-y-3"></div>
        <div class="flex gap-3">
          <button
            onclick="saveOpponents()"
            class="flex-1 px-4 py-3 font-bold text-gray-900 transition duration-300 transform rounded-lg bg-amber-500 hover:bg-amber-600 hover:scale-105"
          >
            üéØ Simpan & Mulai Prediksi (Ctrl+S)
          </button>
          <button
            onclick="loadFromHistory()"
            class="px-4 py-3 font-bold text-white transition duration-300 bg-blue-600 rounded-lg hover:bg-blue-700"
            title="Load data terakhir"
          >
            üìã Load
          </button>
        </div>
      </div>

      <div
        id="predictionSection"
        class="hidden p-6 bg-gray-800 rounded-lg shadow-2xl glow"
      >
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold text-amber-400">
            üîÆ Atur Urutan Musuh
          </h2>
          <button
            onclick="resetApp()"
            class="px-4 py-2 text-sm text-white transition duration-300 bg-red-600 rounded-lg hover:bg-red-700"
          >
            üîÑ Reset
          </button>
        </div>
        <p class="mb-4 text-sm text-gray-300">
          üí° Pilih 6 musuh pertama, yang ke-7 akan otomatis terisi
        </p>

        <div id="selectionList" class="mb-6 space-y-3"></div>

        <div
          class="p-6 mt-6 border-2 rounded-lg bg-gradient-to-br from-amber-900 to-gray-900 border-amber-500 glow"
        >
          <h3 class="mb-2 text-2xl font-bold text-center text-amber-400">
            üìä URUTAN PLAYER AKTIF
          </h3>
          <p class="mb-4 text-sm text-center text-gray-300">
            üí° Urutan di bawah disesuaikan dengan player yang **aktif**
          </p>
          <ol id="orderDisplay" class="space-y-3"></ol>
        </div>
      </div>
    </div>

    <script>
      let opponents = [];
      let selectedOrder = new Array(7).fill(null);
      let eliminatedPlayers = new Set();
      let fightingPlayer = null;

      const STORAGE_KEYS = {
        opponents: "magicChess_opponents",
        order: "magicChess_order",
        eliminated: "magicChess_eliminated",
        fighting: "magicChess_fighting",
        history: "magicChess_history",
      };

      function showSavedIndicator() {
        const indicator = document.getElementById("savedIndicator");
        indicator.classList.remove("hidden");
        setTimeout(() => indicator.classList.add("hidden"), 2000);
      }

      function saveToLocalStorage() {
        localStorage.setItem(STORAGE_KEYS.opponents, JSON.stringify(opponents));
        localStorage.setItem(STORAGE_KEYS.order, JSON.stringify(selectedOrder));
        localStorage.setItem(
          STORAGE_KEYS.eliminated,
          JSON.stringify([...eliminatedPlayers])
        );
        localStorage.setItem(STORAGE_KEYS.fighting, fightingPlayer || "");
        showSavedIndicator();
      }

      function saveToHistory() {
        if (opponents.length > 0) {
          const history = {
            opponents: opponents,
            timestamp: new Date().toISOString(),
            date: new Date().toLocaleString("id-ID"),
          };
          localStorage.setItem(STORAGE_KEYS.history, JSON.stringify(history));
        }
      }

      function loadFromHistory() {
        const history = localStorage.getItem(STORAGE_KEYS.history);
        if (history) {
          const data = JSON.parse(history);
          if (confirm(`Load data dari ${data.date}?`)) {
            for (let i = 0; i < 7; i++) {
              const input = document.getElementById(`opponent${i + 1}`);
              if (input) input.value = data.opponents[i] || "";
            }
            alert("‚úÖ Data berhasil di-load!");
          }
        } else {
          alert("‚ö†Ô∏è Tidak ada history tersimpan!");
        }
      }

      function loadFromLocalStorage() {
        const savedOpponents = localStorage.getItem(STORAGE_KEYS.opponents);
        const savedOrder = localStorage.getItem(STORAGE_KEYS.order);
        const savedEliminated = localStorage.getItem(STORAGE_KEYS.eliminated);
        const savedFighting = localStorage.getItem(STORAGE_KEYS.fighting);

        if (savedOpponents) {
          opponents = JSON.parse(savedOpponents);
          selectedOrder = JSON.parse(
            savedOrder || "[null,null,null,null,null,null,null]"
          );
          eliminatedPlayers = new Set(JSON.parse(savedEliminated || "[]"));
          fightingPlayer = savedFighting || null;

          if (opponents.length > 0) {
            document.getElementById("inputSection").classList.add("hidden");
            document
              .getElementById("predictionSection")
              .classList.remove("hidden");
            generateSelectionList();
            updateOrderDisplay();
          }
        }
      }

      function initInputFields() {
        const container = document.getElementById("inputFields");
        container.innerHTML = ""; // Bersihkan jika sudah ada

        for (let i = 1; i <= 7; i++) {
          const div = document.createElement("div");
          div.className = "flex items-center space-x-2";
          div.innerHTML = `
            <span class="w-8 font-bold text-amber-400">${i}.</span>
            <input type="text" 
                    id="opponent${i}" 
                    placeholder="Nama musuh ${i}"
                    class="flex-1 px-4 py-2 text-white bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"
                    maxlength="30"
                    onkeypress="if(event.key==='Enter' && ${i}<7) document.getElementById('opponent${
            i + 1
          }').focus(); else if(event.key==='Enter' && ${i}===7) saveOpponents();">
                `;
          container.appendChild(div);
        }
        const firstInput = document.getElementById("opponent1");
        if (firstInput) firstInput.focus();
      }

      function saveOpponents() {
        const newOpponents = [];
        let allFilled = true;
        const nameSet = new Set();

        for (let i = 1; i <= 7; i++) {
          const input = document.getElementById(`opponent${i}`);
          const name = input.value.trim();

          if (name === "") {
            allFilled = false;
            input.classList.add("ring-2", "ring-red-500");
          } else if (nameSet.has(name.toLowerCase())) {
            alert(`‚ö†Ô∏è Nama "${name}" sudah digunakan!`);
            input.classList.add("ring-2", "ring-red-500");
            return;
          } else {
            input.classList.remove("ring-2", "ring-red-500");
            newOpponents.push(name);
            nameSet.add(name.toLowerCase());
          }
        }

        if (!allFilled) {
          alert("‚ö†Ô∏è Mohon isi semua 7 nama musuh!");
          return;
        }

        const namesChanged =
          JSON.stringify(opponents) !== JSON.stringify(newOpponents);

        opponents = newOpponents;

        if (namesChanged) {
          selectedOrder = new Array(7).fill(null);
          eliminatedPlayers.clear();
          fightingPlayer = null;
        }

        document.getElementById("inputSection").classList.add("hidden");
        document.getElementById("predictionSection").classList.remove("hidden");

        generateSelectionList();
        updateOrderDisplay();

        saveToLocalStorage();
        saveToHistory();
      }

      function getLastRemaining() {
        const selected = selectedOrder
          .slice(0, 6)
          .filter((item) => item !== null);
        const remaining = opponents.filter((name) => !selected.includes(name));
        return remaining.length === 1 ? remaining[0] : null;
      }

      function autoFillLast() {
        const lastRemaining = getLastRemaining();
        if (lastRemaining) {
          selectedOrder[6] = lastRemaining;
          return true;
        } else {
          selectedOrder[6] = null;
        }
        return false;
      }

      // Fungsi pembantu baru untuk mengisi opsi dropdown (DIPERBAIKI)
      function populateSelectOptions(selectElement, position) {
        // 1. Kumpulkan nama-nama yang sudah dipilih di posisi 1-6
        const selectedNames = selectedOrder
          .slice(0, 6)
          .filter((item) => item !== null);

        // 2. Simpan nilai yang sedang dipilih (untuk mempertahankan pilihan setelah refresh opsi)
        const currentValue = selectedOrder[position] || "";

        // 3. Buat ulang opsi, mulai dengan placeholder/default
        selectElement.innerHTML = `
        <option value="" disabled ${currentValue === "" ? "selected" : ""}>
            -- Pilih Musuh untuk Posisi ${position + 1} --
        </option>
    `;

        opponents.forEach((name) => {
          // Cek apakah nama ini sudah dipilih di posisi lain
          const isSelectedElsewhere =
            selectedNames.includes(name) && name !== currentValue;

          // Hanya tampilkan jika belum dipilih di tempat lain
          if (!isSelectedElsewhere) {
            const option = document.createElement("option");
            option.value = name;
            option.textContent = name;

            // Tandai opsi yang sedang dipilih
            if (currentValue === name) {
              option.selected = true;
            }
            selectElement.appendChild(option);
          }
        });

        // Jika currentValue ada tetapi tidak ada di daftar opsi yang dihasilkan
        // (ini terjadi jika nama tersebut baru saja dipilih di slot lain),
        // kita perlu memastikan selectElement.value diatur dengan benar.
        if (currentValue === "") {
          selectElement.value = ""; // Memilih placeholder
        }
      }

      // Modifikasi pada generateSelectionList (Hanya bagian 1-6)
      function generateSelectionList() {
        // ... (Logika awal sama) ...
        const container = document.getElementById("selectionList");
        const shouldAutoFill = autoFillLast();

        if (container.children.length === 0) {
          // ... (Logika inisialisasi div sama) ...
          for (let position = 0; position < 7; position++) {
            const div = document.createElement("div");
            div.id = `slot-container-${position}`;
            container.appendChild(div);
          }
        }

        for (let position = 0; position < 7; position++) {
          const div = document.getElementById(`slot-container-${position}`);
          const isSelected = selectedOrder[position] !== null;
          const isAutoFilled = position === 6 && shouldAutoFill;

          // ... (Perbarui kelas CSS kontainer sama) ...
          div.className = `p-4 rounded-lg flex items-center space-x-3 transition duration-200 ${
            isAutoFilled
              ? "auto-filled-slot"
              : isSelected
              ? "filled-slot"
              : "empty-slot"
          }`;

          // POSISI 7 (Auto-Fill) - Logika sama
          if (position === 6) {
            // ... (Logika posisi 7 sama) ...
            const newContent = `
                <span class="flex items-center justify-center w-10 h-10 text-lg font-bold rounded-full ${
                  isAutoFilled
                    ? "bg-green-500 text-gray-900"
                    : "bg-gray-600 text-gray-400"
                } position-badge">
                    7
                </span>
                <div class="flex-1">
                    <div class="px-4 py-3 text-white bg-gray-700 border-2 rounded-lg ${
                      isAutoFilled ? "border-green-500" : "border-gray-600"
                    }">
                        ${
                          isAutoFilled
                            ? `<span class="font-bold">${selectedOrder[6]}</span> <span class="ml-2 text-sm text-green-400 auto-label">‚úì Otomatis Terisi</span>`
                            : '<span class="text-gray-500">Akan terisi otomatis</span>'
                        }
                    </div>
                </div>
                ${
                  isAutoFilled
                    ? `
                        <button onclick="clearSelection(6)" 
                                class="px-4 py-2 text-sm font-bold text-white transition bg-red-600 rounded-lg hover:bg-red-700">
                            ‚úï Clear
                        </button>
                    `
                    : `
                        <div class="w-20"></div>
                    `
                }
            `;
            if (div.innerHTML.trim() !== newContent.trim()) {
              div.innerHTML = newContent;
            }
          }
          // POSISI 1-6 (Dropdown)
          else {
            let select = document.getElementById(`select${position}`);
            let clearBtn = document.getElementById(`clear-btn-${position}`);

            // Buat struktur utamanya HANYA SEKALI
            if (!select) {
              div.innerHTML = `
                    <span class="flex items-center justify-center w-10 h-10 text-lg font-bold text-gray-900 rounded-full bg-amber-500 position-badge">
                        ${position + 1}
                    </span>
                    <div class="relative flex-1 select-container">
                        <select id="select${position}" 
                                onchange="handleSelection(${position}, this.value)"
                                class="w-full px-4 py-3 text-white bg-gray-700 border-2 border-gray-600 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500 hover:border-amber-400 transition">
                        </select>
                        <span class="text-amber-400 select-arrow">‚ñº</span>
                    </div>
                    <button id="clear-btn-${position}" onclick="clearSelection(${position})" 
                            class="px-4 py-2 text-sm font-bold text-white transition bg-red-600 rounded-lg hover:bg-red-700 ${
                              isSelected ? "" : "hidden"
                            }">
                        ‚úï Clear
                    </button>
                `;
              select = document.getElementById(`select${position}`);
              clearBtn = document.getElementById(`clear-btn-${position}`);
            }

            // Panggil fungsi pembantu: HANYA perbarui opsi di dalam dropdown
            populateSelectOptions(select, position);

            // Perbarui visibilitas tombol Clear
            if (clearBtn) {
              if (isSelected) {
                clearBtn.classList.remove("hidden");
              } else {
                clearBtn.classList.add("hidden");
              }
            }
          }
        }
      }
      function handleSelection(position, value) {
        // Simpan nama musuh yang mungkin terisi otomatis di slot 7 sebelumnya
        const prevAutoFillName = selectedOrder[6];

        // Hapus nama ini dari posisi lain jika sebelumnya terisi
        const existingIndex = selectedOrder.indexOf(value);
        if (existingIndex !== -1 && existingIndex !== position) {
          selectedOrder[existingIndex] = null;
        }

        // Set new selection
        selectedOrder[position] = value === "" ? null : value;

        // Regenerate to update all dropdowns and auto-fill if needed
        generateSelectionList();
        updateOrderDisplay();
        saveToLocalStorage();

        // Dapatkan nama baru yang mungkin terisi otomatis
        const currentAutoFillName = selectedOrder[6];

        // --- PENINGKATAN UX BARU: Highlight Slot 7 jika terjadi perubahan ---
        if (currentAutoFillName !== prevAutoFillName) {
          const slot7Div = document.getElementById("slot-container-6"); // Slot 7 adalah index 6
          if (slot7Div) {
            // Tambahkan kelas animasi ke kontainer slot 7
            slot7Div.classList.add("success-animation");
            setTimeout(
              () => slot7Div.classList.remove("success-animation"),
              500
            );
          }
        }

        // Add success animation to the currently selected slot (existing logic)
        setTimeout(() => {
          const div = document.getElementById(`slot-container-${position}`);
          if (div) {
            div.classList.add("success-animation");
            setTimeout(() => div.classList.remove("success-animation"), 500);
          }
        }, 10);
      }

      function clearSelection(position) {
        selectedOrder[position] = null;

        generateSelectionList();
        updateOrderDisplay();
        saveToLocalStorage();
      }

      // Fungsi updateOrderDisplay yang sudah disempurnakan (UX: Urutan Aktif)
      function updateOrderDisplay() {
        const container = document.getElementById("orderDisplay");
        container.innerHTML = "";

        // 1. Filter pemain yang belum tereliminasi, pertahankan urutan asli
        const activePlayers = selectedOrder.filter(
          (name) => name !== null && !eliminatedPlayers.has(name)
        );

        let hasAnySelection = activePlayers.length > 0;

        activePlayers.forEach((name, newIndex) => {
          // Cari index asli di selectedOrder (untuk cek Auto-Fill)
          const originalIndex = selectedOrder.indexOf(name);

          const isFighting = fightingPlayer === name;
          const isAutoFilled =
            originalIndex === 6 && getLastRemaining() === name;

          // newIndex adalah urutan yang sebenarnya (1, 2, 3, ...)
          const displayIndex = newIndex + 1;

          const li = document.createElement("li");
          li.className = `bg-gray-800 rounded-lg p-4 flex items-center space-x-3 border-2 border-gray-600 hover:border-amber-400 transition duration-300 ${
            isFighting ? "fighting" : ""
          }`;

          // Tampilan baru menggunakan displayIndex
          li.innerHTML = `
                <div class="font-black rounded-full flex items-center justify-center text-xl shadow-lg ${"bg-amber-500 w-12 h-12"} text-gray-900 ${
            isFighting ? "fighting-pulse" : ""
          }" 
                    onclick="event.stopPropagation(); toggleFighting('${name}');"
                    style="cursor: pointer;">
                    ${displayIndex}
                </div>
                <div class="flex-1" onclick="toggleFighting('${name}');" style="cursor: pointer;">
                    <div class="text-lg font-bold text-white player-name">
                        ${name}
                    </div>
                    <div class="text-sm text-gray-400">
                        ${
                          isFighting
                            ? "‚öîÔ∏è Fighting!"
                            : "Urutan Slot " + (originalIndex + 1)
                        }
                    </div>
                </div>
                <div class="text-3xl">
                    ${
                      displayIndex === 1
                        ? "ü•á"
                        : displayIndex === 2
                        ? "ü•à"
                        : displayIndex === 3
                        ? "ü•â"
                        : "üéØ"
                    }
                </div>
                <button onclick="event.stopPropagation(); eliminatePlayer('${name}');" 
                    class="flex items-center px-4 py-2 space-x-1 text-sm font-bold text-white bg-red-600 rounded-lg shadow-lg eliminate-btn hover:bg-red-700">
                    <span>üíÄ</span>
                    <span>Kill</span>
                </button>
            `;
          container.appendChild(li);
        });

        // Tambahkan daftar pemain yang tereliminasi (di bagian bawah)
        if (eliminatedPlayers.size > 0) {
          const eliminatedList = document.createElement("li");
          eliminatedList.className =
            "p-4 mt-4 text-center text-gray-400 bg-gray-900 rounded-lg";
          eliminatedList.innerHTML = `
                <h4 class="mb-2 text-red-400 font-bold">üíÄ TERELIMINASI (${
                  eliminatedPlayers.size
                } Player)</h4>
                <div class="text-sm">
                    ${[...eliminatedPlayers]
                      .map(
                        (name) =>
                          `<span class="line-through mx-2 text-red-500 cursor-pointer hover:text-red-300 transition" onclick="undoElimination('${name}')">${name}</span>`
                      )
                      .join(" | ")}
                </div>
            `;
          container.appendChild(eliminatedList);
        }

        if (!hasAnySelection && eliminatedPlayers.size === 0) {
          container.innerHTML =
            '<li class="p-4 text-center text-gray-500">Belum ada urutan yang dipilih</li>';
        }
      }

      function toggleFighting(playerName) {
        if (eliminatedPlayers.has(playerName)) {
          return;
        }

        if (fightingPlayer === playerName) {
          fightingPlayer = null;
        } else {
          fightingPlayer = playerName;
        }
        updateOrderDisplay();

        saveToLocalStorage();
      }

      function eliminatePlayer(playerName) {
        eliminatedPlayers.add(playerName);
        if (fightingPlayer === playerName) {
          fightingPlayer = null;
        }
        updateOrderDisplay(); // Memperbarui urutan aktif

        saveToLocalStorage();
      }

      function undoElimination(playerName) {
        eliminatedPlayers.delete(playerName);
        updateOrderDisplay();

        saveToLocalStorage();
      }

      function resetApp() {
        if (confirm("üîÑ Yakin ingin mereset? Data akan hilang.")) {
          opponents = [];
          selectedOrder = new Array(7).fill(null);
          eliminatedPlayers.clear();
          fightingPlayer = null;

          Object.values(STORAGE_KEYS).forEach((key) => {
            if (key !== STORAGE_KEYS.history) {
              localStorage.removeItem(key);
            }
          });

          document.getElementById("inputSection").classList.remove("hidden");
          document.getElementById("predictionSection").classList.add("hidden");

          initInputFields();
        }
      }

      // Keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        if (e.ctrlKey || e.metaKey) {
          if (e.key === "s") {
            e.preventDefault();
            if (
              !document
                .getElementById("inputSection")
                .classList.contains("hidden")
            ) {
              saveOpponents();
            }
          }
        }
      });

      window.addEventListener("DOMContentLoaded", () => {
        initInputFields();
        loadFromLocalStorage();
      });
    </script>
  </body>
</html>
